"""
Quick plotter for trajectory_output.csv generated by the C# optimizer
"""

import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from matplotlib.patches import Circle
import numpy as np

# Load data
print("Loading trajectory data...")
df = pd.read_csv('trajectory_output.csv')

# Separate by type
spacecraft_df = df[df['type'] == 'spacecraft']
earth_df = df[df['type'] == 'earth']
mars_df = df[df['type'] == 'mars']
jupiter_df = df[df['type'] == 'jupiter']

print(f"Loaded {len(spacecraft_df)} spacecraft positions")
print(f"Loaded {len(earth_df)} planet positions")

# Create figure
fig, ax = plt.subplots(figsize=(14, 14))
ax.set_aspect('equal')
ax.set_facecolor('#0a0a1a')
fig.patch.set_facecolor('#0a0a1a')

# Set limits
ax.set_xlim(-8, 8)
ax.set_ylim(-8, 8)

# Plot Sun
ax.plot(0, 0, 'o', color='#FDB813', markersize=25, label='Sun', zorder=10)

# Plot orbital paths
circle_earth = Circle((0, 0), 1.0, fill=False, color='#4A90E2', alpha=0.2, linestyle='--', linewidth=1)
circle_mars = Circle((0, 0), 1.52, fill=False, color='#E74C3C', alpha=0.2, linestyle='--', linewidth=1)
circle_jupiter = Circle((0, 0), 5.2, fill=False, color='#D35400', alpha=0.2, linestyle='--', linewidth=1)
ax.add_patch(circle_earth)
ax.add_patch(circle_mars)
ax.add_patch(circle_jupiter)

# Plot complete spacecraft trajectory as thin line
ax.plot(spacecraft_df['x_au'], spacecraft_df['y_au'], 
        color='cyan', alpha=0.4, linewidth=1, label='Spacecraft Path')

# Initialize animated elements
spacecraft_dot, = ax.plot([], [], 'o', color='white', markersize=10, 
                          label='Spacecraft', zorder=15, markeredgecolor='cyan', markeredgewidth=2)
spacecraft_trail, = ax.plot([], [], '-', color='cyan', linewidth=2, alpha=0.8)

earth_dot, = ax.plot([], [], 'o', color='#4A90E2', markersize=12, label='Earth', zorder=12)
mars_dot, = ax.plot([], [], 'o', color='#E74C3C', markersize=9, label='Mars', zorder=12)
jupiter_dot, = ax.plot([], [], 'o', color='#D35400', markersize=18, label='Jupiter', zorder=12)

# Info text
info_text = ax.text(0.02, 0.98, '', transform=ax.transAxes,
                    color='white', fontsize=11, verticalalignment='top',
                    fontfamily='monospace',
                    bbox=dict(boxstyle='round', facecolor='#1a1a2e', alpha=0.9, edgecolor='cyan'))

# Title and labels
ax.set_xlabel('X (AU)', color='white', fontsize=13, fontweight='bold')
ax.set_ylabel('Y (AU)', color='white', fontsize=13, fontweight='bold')
ax.set_title('Earth to Jupiter Trajectory - Genetic Algorithm Optimization',
             color='white', fontsize=16, fontweight='bold', pad=20)

# Legend
legend = ax.legend(loc='upper right', facecolor='#1a1a2e', edgecolor='cyan',
                   labelcolor='white', fontsize=10, framealpha=0.9)

# Grid
ax.grid(True, alpha=0.15, color='white', linestyle=':', linewidth=0.5)
ax.tick_params(colors='white', labelsize=10)

# Animation parameters
trail_length = 80  # Number of points to show in trail
speed_factor = 5   # Skip frames for faster playback

def init():
    spacecraft_dot.set_data([], [])
    spacecraft_trail.set_data([], [])
    earth_dot.set_data([], [])
    mars_dot.set_data([], [])
    jupiter_dot.set_data([], [])
    info_text.set_text('')
    return spacecraft_dot, spacecraft_trail, earth_dot, mars_dot, jupiter_dot, info_text

def animate(frame):
    idx = frame * speed_factor
    if idx >= len(spacecraft_df):
        idx = len(spacecraft_df) - 1
    
    # Spacecraft position
    sc_x = spacecraft_df.iloc[idx]['x_au']
    sc_y = spacecraft_df.iloc[idx]['y_au']
    spacecraft_dot.set_data([sc_x], [sc_y])
    
    # Spacecraft trail
    start_idx = max(0, idx - trail_length)
    trail_x = spacecraft_df.iloc[start_idx:idx]['x_au']
    trail_y = spacecraft_df.iloc[start_idx:idx]['y_au']
    spacecraft_trail.set_data(trail_x, trail_y)
    
    # Planet positions
    if idx < len(earth_df):
        earth_dot.set_data([earth_df.iloc[idx]['x_au']], [earth_df.iloc[idx]['y_au']])
        mars_dot.set_data([mars_df.iloc[idx]['x_au']], [mars_df.iloc[idx]['y_au']])
        jupiter_dot.set_data([jupiter_df.iloc[idx]['x_au']], [jupiter_df.iloc[idx]['y_au']])
        
        # Calculate distance to Jupiter
        jup_x = jupiter_df.iloc[idx]['x_au']
        jup_y = jupiter_df.iloc[idx]['y_au']
        dist_to_jup = np.sqrt((sc_x - jup_x)**2 + (sc_y - jup_y)**2)
        
        # Info text
        time_str = spacecraft_df.iloc[idx]['time']
        days_elapsed = idx * 24 / 12  # Approximate days
        
        info_text.set_text(
            f'Time: {time_str}\n'
            f'Mission Day: {days_elapsed:.0f}\n'
            f'Distance to Jupiter: {dist_to_jup:.3f} AU\n'
            f'                    ({dist_to_jup * 1.496e8:.0f} km)'
        )
    
    return spacecraft_dot, spacecraft_trail, earth_dot, mars_dot, jupiter_dot, info_text

# Create animation
num_frames = len(spacecraft_df) // speed_factor
print(f"\nCreating animation with {num_frames} frames...")

anim = animation.FuncAnimation(
    fig, animate, init_func=init,
    frames=num_frames, interval=20,
    blit=True, repeat=True
)

print("Showing animation... (Close window when done)")
print("The animation will loop continuously.\n")

plt.tight_layout()
plt.show()

